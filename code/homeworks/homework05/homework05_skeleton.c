#include <stdint.h>
#include <stdbool.h>
#include "baremetal_binary.h"

// MVC defines
#define DISP_WIDTH (16)
#define CATCH_SCORE (3)
#define MISS_PENALTY (1)
#define MAX_TICK (20)

// VIEW
#define MATRIX     ((volatile uint8_t * const)0xE020U)
#define SCORE      ((volatile uint8_t * const)0xE800U)
#define PLAYER_COL ((volatile uint8_t * const)0xE801U)

// SIDE CHANNEL
#define RANDOM_DISP ((volatile uint8_t * const)0xE808U)

// CONTROLLER
#define KEYPAD ((const volatile uint8_t * const)0xD010U)

// CONTROLLER-MODEL API
typedef enum {
    NONE, LEFT, RIGHT
} command;

// MODEL states
typedef struct {
    uint8_t player_col; // Player is always Row 0
    uint8_t coin_row;
    uint8_t coin_col;
    uint8_t score;
    uint8_t tick;
    // You might not need the full 'matrix[16]' array in the model 
    // if you calculate positions dynamically during View Update,
    // but keeping it is fine too.
} model_t;

// MODEL helper -- create random
uint8_t random4(uint8_t seed){
    static const uint8_t seq4[256] = {
        0x3, 0xE, 0x1, 0x9, 0xC, 0x5, 0xB, 0x7, 0x2, 0xF, 0x8, 0x0, 0xA, 0x6, 0x4, 0xD,
        0x9, 0x2, 0xF, 0xB, 0x4, 0x7, 0x0, 0xE, 0xC, 0x5, 0x8, 0xA, 0x1, 0x6, 0xD, 0x3,
        0xE, 0x8, 0x5, 0x0, 0xB, 0x3, 0x9, 0x6, 0xF, 0x2, 0xC, 0xA, 0x7, 0x4, 0xD, 0x1,
        0x6, 0xB, 0x2, 0xD, 0x8, 0x1, 0xE, 0x5, 0x0, 0x9, 0x4, 0xF, 0xA, 0x7, 0xC, 0x3,
        0xA, 0x4, 0xD, 0x8, 0x1, 0xE, 0x5, 0x2, 0xF, 0x9, 0xC, 0x3, 0x7, 0xB, 0x0, 0x6,
        0x5, 0xC, 0x7, 0x1, 0xE, 0x8, 0xB, 0x4, 0x9, 0x2, 0xF, 0x0, 0xD, 0x6, 0xA, 0x3,
        0xF, 0x0, 0x9, 0x3, 0xA, 0x6, 0xD, 0x8, 0x2, 0xB, 0x5, 0xE, 0x1, 0xC, 0x7, 0x4,
        0x1, 0x7, 0xC, 0xA, 0x3, 0xF, 0x6, 0x9, 0xD, 0x4, 0x0, 0x2, 0x8, 0xE, 0xB, 0x5,
        0x8, 0xD, 0x4, 0xF, 0x2, 0x9, 0x0, 0xC, 0x6, 0xA, 0x3, 0xB, 0xE, 0x5, 0x1, 0x7,
        0xC, 0x3, 0xA, 0x6, 0xF, 0x0, 0xD, 0x5, 0x8, 0x1, 0xE, 0x9, 0x4, 0x7, 0x2, 0xB,
        0x2, 0x9, 0xE, 0x4, 0x7, 0xB, 0x1, 0xA, 0x5, 0xD, 0x8, 0x6, 0xC, 0x0, 0xF, 0x3,
        0xD, 0x6, 0x8, 0x2, 0xB, 0x4, 0x9, 0xE, 0x3, 0xF, 0x1, 0x7, 0xA, 0xC, 0x5, 0x0,
        0x7, 0x1, 0x5, 0xC, 0x9, 0xD, 0x2, 0xF, 0xB, 0x8, 0xE, 0x3, 0x6, 0xA, 0x4, 0x0,
        0x4, 0xA, 0x3, 0x7, 0x6, 0x0, 0xF, 0xB, 0x1, 0xE, 0x9, 0xD, 0x2, 0x5, 0x8, 0xC,
        0xB, 0x5, 0x0, 0xE, 0xD, 0x7, 0xA, 0x1, 0x4, 0xC, 0x2, 0x8, 0xF, 0x3, 0x6, 0x9,
        0x0, 0xF, 0x6, 0xB, 0x5, 0x2, 0x8, 0xC, 0x7, 0x3, 0xA, 0x4, 0x9, 0x1, 0xD, 0xE
    };
    static uint8_t counter = 7;
    counter = counter + seed + 1;
    return seq4[counter];
}

// MODEL init
void model_init(model_t *mp, uint8_t random){
    // add code
}

// MODEL update
void model_update(model_t *mp, uint8_t random, command c){
    switch(c) {
        // add cases here:
    }

    // this is the hardest part.
    // Look at the table on homework web page to see what to do.
}

// VIEW
void view_update(const model_t *mp){
    // draw coin and player
    // show score
}

// CONTROLLER
command controller_read(void){
    static command c;
    uint8_t key = *KEYPAD;
    // add code
}

void main(void){
    model_t m;
    model_t *mp = &m;
    command c;
    uint8_t random = 0;
    model_init(mp, random);
    while (true){
        c = controller_read();
        model_update(mp, random, c);
        view_update(mp);
        *RANDOM_DISP = random;
        random = random + 1 + (uint8_t ) c;
    }
}
